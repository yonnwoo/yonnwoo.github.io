<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>글쓰기 페이지 (Admin)</title>
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    
    <link rel="stylesheet" href="style.css"> 
    <style>
        /* Quill 편집기 높이 설정 */
        #editor-container { height: 300px; margin-bottom: 1rem; background-color: white; color: #333; }
        /* 로그인 폼 스타일 */
        #login-form { max-width: 400px; margin: 3rem auto; padding: 2rem; border: 1px dashed #ccc; }
        #login-form label { display: block; margin-bottom: 0.5rem; }
        #login-form input { width: 100%; padding: 0.5rem; margin-bottom: 1rem; border: 1px solid #ccc; box-sizing: border-box;}
        #login-message { color: red; margin-top: 1rem; }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
        const SUPABASE_URL = 'https://iuvgxecoxpkhrklfaail.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1dmd4ZWNveHBraHJrbGZhYWlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2OTAwODksImV4cCI6MjA3NjI2NjA4OX0.lcyTqGEm6QV_Ogdlv0gzEKZQPFogE9psDhFzu1Q-G9Y';
        // supabaseClient를 전역 변수로 선언하여 아래 스크립트에서도 사용 가능하게 함
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function checkLogin() {
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            if (error || !session) {
                alert("로그인이 필요합니다.");
                window.location.href = 'login.html';
            } else {
                console.log('로그인된 사용자:', session.user);
            }
        }
        checkLogin();
    </script>
</head>

<body>

    <main style="padding: 30px;">
        <h2>새 블로그 글 작성</h2>
        
        <form id="write-form">
            <label for="post-title">제목:</label>
            <input type="text" id="post-title" required>
            
            <label for="post-content">내용:</label>
            <div id="editor-container"></div> 
            
            <button type="submit">게시글 저장하기</button>
        </form>

        <p id="status-message"></p>
        <a href="index.html">← 메인 페이지로 돌아가기</a>
    </main>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script>
        // Quill 편집기 초기화
        const quill = new Quill('#editor-container', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline'],        
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['link', 'blockquote', 'code-block'],
                    ['clean']                                         
                ]
            }
        });

        const writeForm = document.getElementById('write-form');
        const statusMessage = document.getElementById('status-message');

        writeForm.addEventListener('submit', savePost);

        async function savePost(event) {
            event.preventDefault();
            statusMessage.textContent = '저장하는 중...';

            const titleInput = document.getElementById('post-title');
            const contentHTML = quill.root.innerHTML; 

            if (quill.getLength() <= 1 && !quill.getText().trim()) {
                 statusMessage.textContent = '내용을 입력해주세요.';
                 statusMessage.style.color = 'orange';
                 return;
            }

            // ⭐ 위에서 선언한 supabaseClient 변수를 사용 ⭐
            const { data, error } = await supabaseClient 
                .from('posts')
                .insert([
                    { title: titleInput.value, content: contentHTML } 
                ]);

            if (error) {
                console.error('저장 중 에러 발생:', error);
                statusMessage.textContent = `에러 발생: ${error.message}`;
                statusMessage.style.color = 'red';
            } else {
                console.log('게시글이 성공적으로 저장되었습니다:', data);
                statusMessage.textContent = '게시글이 성공적으로 저장되었습니다!';
                statusMessage.style.color = 'green';
                
                titleInput.value = '';
                quill.setContents([]); 
            }
        }
    </script>
    
</body>
</html>